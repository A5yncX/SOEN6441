@()

<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>WebSocket YouTube Service</title>
        <script>
                let socket;
                const MAX_RESULTS = 100; // Maximum results to display
                let allVideos = []; // Array to store all videos for this session

                function connectWebSocket() {
                    socket = new WebSocket(`ws://${window.location.host}/websocket`);

                    socket.onmessage = function (event) {
                        const data = JSON.parse(event.data);
                        console.log("Message from server:", data);

                        if (data.error) {
                            document.getElementById("messages").innerHTML += `<p class="error">Error: ${data.error}</p>`;
                        } else {
                            addVideos(data);
                            displayVideos();
                        }
                    };

                    socket.onopen = function () {
                        console.log("WebSocket connection established.");
                        document.getElementById("status").innerText = "Connected";
                    };

                    socket.onclose = function () {
                        console.log("WebSocket connection closed.");
                        document.getElementById("status").innerText = "Disconnected";
                    };

                    socket.onerror = function (error) {
                        console.error("WebSocket error:", error);
                        document.getElementById("status").innerText = "Error";
                    };
                }

                function extractChannelId(channelUrl) {
                    // Extract channelId from the channelUrl
                    const parts = channelUrl.split("/");
                    return parts[parts.length - 1]; // Return the last segment
                }

                function addVideos(newVideos) {
                    allVideos = [...newVideos, ...allVideos];
                    if (allVideos.length > MAX_RESULTS) {
                        allVideos = allVideos.slice(0, MAX_RESULTS);
                    }
                }

                function displayVideos() {
                    const messages = document.getElementById("messages");
                    messages.innerHTML = "";

                    allVideos.forEach(video => {
                        const channelId = extractChannelId(video.channelUrl); // Extract channelId from channelUrl
                        const videoHtml = `
                        <div class="video-wrapper">
                            <img src="${video.thumbnailUrl}" class="thumbnail" alt="Thumbnail">
                            <div class="video-info">
                                <a href="${video.videoUrl}" target="_blank" class="video-title">${video.title}</a>
                                <div class="channel-title">
                                    Channel: <a href="/channelactor?channelId=${encodeURIComponent(channelId)} " target="_blank" class="channel-link">
                                        ${video.channelTitle}
                                    </a>
                                </div>
                                <div class="description">Description: ${video.description || "No description available"}</div>
                            </div>
                        </div>
                    `;
                        messages.innerHTML += videoHtml;
                    });
                }

                function sendQuery() {
                    const query = document.getElementById("query").value.trim();
                    if (socket && socket.readyState === WebSocket.OPEN) {
                        socket.send(JSON.stringify({ query: query }));
                        console.log("Sent:", query);
                    } else {
                        alert("WebSocket is not connected.");
                    }
                }

                window.onload = connectWebSocket;
        </script>
        <style>
                body {
                    font-family: Arial, sans-serif;
                    margin: 20px;
                }
                .error {
                    color: red;
                }
                #status {
                    font-weight: bold;
                    margin-bottom: 10px;
                }
                .video-wrapper {
                    display: flex;
                    align-items: flex-start;
                    margin-bottom: 20px;
                    padding: 10px;
                    border: 1px solid #ccc;
                    border-radius: 5px;
                }
                .thumbnail {
                    width: 120px;
                    height: auto;
                    margin-right: 15px;
                    border-radius: 5px;
                }
                .video-info {
                    flex: 1;
                }
                .video-title {
                    font-size: 16px;
                    font-weight: bold;
                    color: #000;
                    text-decoration: none;
                }
                .video-title:hover {
                    text-decoration: underline;
                }
                .channel-title {
                    font-size: 14px;
                    color: #555;
                    margin-top: 5px;
                }
                .channel-link {
                    color: #007bff;
                    text-decoration: none;
                }
                .channel-link:hover {
                    text-decoration: underline;
                }
                .description {
                    font-size: 14px;
                    color: #777;
                    margin-top: 5px;
                }
        </style>
    </head>
    <body>
        <h1>WebSocket YouTube Service</h1>
        <div>
            <label for="query">Search YouTube:</label>
            <input type="text" id="query" placeholder="Enter search query">
            <button onclick="sendQuery()">Send</button>
        </div>
        <div>
            <p>Status: <span id="status">Disconnected</span></p>
            <h2>Search Results:</h2>
            <div id="messages"></div>
        </div>
    </body>
</html>
